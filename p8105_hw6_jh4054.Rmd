---
title: "p8105_hw6_jh4054"
author: "Joy Hsu"
date: "11/24/2018"
output: 
    html_document:
      toc: true
      toc_float: true
      code_folding: show
---

```{r setup, include=FALSE}
library(tidyverse)
library(knitr)

knitr::opts_chunk$set(
  collapse = TRUE)

theme_set(theme_bw() + theme(legend.position = "bottom"))
```

### Problem 1

The homicide dataset was collated by Washington Post on 52179 homicide cases in 50 major US cities, from 2007 to 2015. Altogether, 28 states are represented. The raw dimensions are 52179 rows by 12 columns variables. Each case is reported as a distinct row, with demographic information on the victim's name, age, sex, and race. Attributes regarding the homicide incident include geospatial coordinates, reported date, city, and disposition of the police case. 
```{r}
#examine raw dataset
raw_dataset = read_csv("./data/homicide-data.csv")
dim(raw_dataset)

#represented states and cities
raw_dataset %>% 
  distinct(state) %>% 
  nrow()

raw_dataset %>% 
  distinct(city) %>% 
  nrow()
```

Load and tidy dataset 

* created variable city_state
* omit "Tulsa, AL", "Dallas, TX", "Phoenix, AZ", "Kansas City, MO"
* modify victim age to numeric variable
* modify victim_race to two factor variable: white (reference) and non_white
* create binary variable indicating whether the homicide is solved: 0 = unsolved, 1 = solved. 

```{r}
#load and tidy dataset
homicide_data = read_csv("./data/homicide-data.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    city_state = str_c(city, ", ", state),
    victim_age = as.numeric(as.factor(victim_age)),
    victim_race = ifelse(victim_race == "White", "white", "non_white"),
    victim_race = fct_relevel(victim_race, c("white", "non_white")),
    victim_sex = as.factor(victim_sex),
    hom_unsolved = as.factor(ifelse(disposition != "Closed by arrest", 0, 1))) %>% 
  filter(!(city_state %in% c("Tulsa, AL", "Dallas, TX", "Phoenix, AZ", "Kansas City, MO")))
```

```{r}
# df with only baltimore victims
baltimore_df = homicide_data %>% 
   filter(city_state == "Baltimore, MD") 

# glm for baltimore unsolved homicides
baltimore_df %>%
  glm(hom_unsolved ~ victim_age + victim_race + victim_sex, family = binomial(), data = .) %>% 
  broom::tidy(conf.int = TRUE, exponentiate = TRUE) %>% 
  select(term, estimate, conf.low, conf.high, p.value) %>% 
  rename(
    "OR" = estimate, 
    "95% CI lower" = conf.low, 
    "95% CI upper" = conf.high) %>% 
  knitr::kable(digits = 3)
  
# NA - add predictions to baltimore dataframe
baltimore_df_pred = baltimore_df %>% 
  modelr::add_predictions(glm_baltimore) %>% 
  mutate(fitted_prob = boot::inv.logit(pred))

glm_baltimore %>% broom::glance()
```

```{r, fig.width = 10, fig.height = 8}
# OR for victim_racenon_white
logfit_cities = homicide_data %>% 
  select(city_state, hom_unsolved, victim_age, victim_race, victim_sex) %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(
    logfit = map(data, ~glm(hom_unsolved ~ victim_age + victim_race + victim_sex, family = binomial(), data = .)),
    logfit = map(logfit, ~broom::tidy(., conf.int = TRUE, exponentiate = TRUE))) %>% 
  select(city_state, logfit) %>% 
  unnest() %>% 
  filter(term == "victim_racenon_white") %>% 
  select(city_state, estimate, conf.low, conf.high, p.value) %>% 
  rename(
    "OR" = estimate, 
    "CI_lower" = conf.low, 
    "CI_upper" = conf.high) %>% 
  mutate(city_state = fct_reorder(city_state, OR))

# OR and 95% CI for each city
logfit_cities %>% 
  arrange(OR) %>% 
  knitr::kable(digits = 3)

# plot
OR_plot = logfit_cities %>% 
  ggplot(aes(x = city_state, y = OR, color = city_state)) +
  geom_point() +
  geom_errorbar(mapping = aes(x = city_state, ymin = CI_lower, ymax = CI_upper)) + 
  labs(
    title = "Odds Ratio of Solving Homicide Case, Race non-white vs. white",
    x = "City",
    y = "Odds Ratio",
    caption = "*Case Data collated by Washington Post") + 
  viridis::scale_color_viridis(
    name = "City, State", 
    discrete = TRUE) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1), 
        legend.position = "bottom")
OR_plot
```

### Problem 2

```{r}
bw = read_csv("./data/birthweight.csv")

bw = bw %>% 
```


